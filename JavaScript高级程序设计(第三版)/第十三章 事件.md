# 第十三章 事件

## 事件流

### 事件冒泡

​		IE 的事件流叫做事件冒泡，即从层次最深的节点接收，然后逐级向上传播至父节点。

### 事件捕获

​		DOM2 级事件规定，从 document 开始逐级向下，但大部分浏览器都是从 window 对象开始。

​		由于老版本浏览器不支持捕获，**建议使用事件冒泡，有特殊需要时再用事件捕获**

### DOM 事件流

​		分为三个阶段：

1. 事件捕获阶段，为截获事件提供机会，DOM2 规定捕获阶段不涉及事件目标，但大部分浏览器都会在此阶段出发事件对象上的事件。故有两个机会在目标对象上操作事件。
2. 处于目标阶段
3. 事件冒泡阶段，可在此阶段对事件作出响应



## 事件处理程序

​		响应某个事件的函数就叫事件处理程序，或事件侦听器。

### HTML 事件处理程序

​		在 HTML 事件特性中直接编写 JavaScript 代码。

### DOM0 级事件处理程序

​		在 JavaScript 代码中，通过给元素对象的事件属性绑定函数即可。使用此方法指定的事件处理程序被认为是元素的方法，因此是在元素的作用域中运行，即程序中的 this 指向当前元素。

​		以这种方法添加的事件处理程序，会在事件流的冒泡阶段被处理。

### DOM2 级事件处理程序

​		DOM2 级事件处理程序定义了两个方法，用于指定和删除事件处理程序的方法，**addEventListener（）**和**removeEventListener（）**，所有 DOM 节点都包含这两个方法，接收三个参数：要处理的事件名称、作为事件处理程序的函数、布尔值。布尔值若为 true，表示在捕获阶段调用处理程序；若为 false，表示在冒泡阶段调用。

​		若添加同名的事件，会按照添加顺序执行。

​		**通过 addEventListener 添加的事件处理程序只能用 removeEventListener 方法移除**，参数与添加事件的相同，这样意味着 添加的匿名函数无法被移除。

​		大多数情况下，都将事件添加到冒泡阶段，以兼容大部分浏览器。（IE9+）

### IE 事件处理程序

​		attachEvent、detachEvent，接收两个参数，事件处理程序名称、事件处理程序函数。由于 IE8 以及更早版本只支持事件冒泡，所以**使用此方法都会将事件添加到冒泡阶段**。

​		**此方法添加的事件处理程序，会在全局作用域下运行，因此 this 等于 window。**

​		**添加同名事件时，执行顺序与添加顺序相反。**

### 跨浏览器的事件处理程序

​		可使用下面的封装：

```javascript
var EventUtil = {
    addHandler : function(element, type, handler){
        if(element.addEventListener){
            element.addEventListener(type, handler, false);
        }else if(element.attachEvent){
            element.attachEvent("on" + type, handler);
        }else{
            element["on" + type] = handler;
        }
    },
    removeHandler : function(element, type, handler){
        if(element.removeEventListener){
            element.removeEventListner(type, handler, false);
        }else if(element.detachEvent){
            element.detachEvent("on" + type, handler);
        }else{
            element["on" + type] = null;
        }
    }
};
```

​		上面代码先检测是否存在 DOM2 级方法，若存在则设置为冒泡阶段执行；否则判断是否存在 IE 的方法，若存在则使用，注意事件名前要加“on”；最后使用 DOM0 级方法，也要加“on”。

​		DOM0 级对每个事件只支持一个处理程序，不过现在已经很少支持 DOM0 级的浏览器了。



## 事件对象

### DOM 中的事件对象

​		使用 DOM0 或 DOM2 都会在事件处理程序中传入 event 对象。event.type 属性表示事件类型。通过 HTML 特性指定事件处理程序时，变量 event 也保存着该对象。event 对象有以下属性和方法：

- bubbles 属性，事件是否冒泡
- cancelable 属性，是否可以取消事件的默认行为
- currentTarget 属性，事件处理程序正在处理事件的元素
- defaultPrevented 属性，为 true 时表示已经调用了 preventDefault（）方法（DOM3 新增）
- detail 属性，与事件相关的细节
- eventPhase 属性，调用事件处理程序的阶段：1、捕获阶段；2、处于目标；3、冒泡阶段
- event 属性，事件的目标元素
- isTrusted 属性，为 true 表示是浏览器生成的；为 false 表示是开发人员通过 JavaScript 创建的（DOM3 新增）
- type 属性，被触发事件的类型
- view 属性，与事件关联的抽象视图，等同于发生事件的 window 对象
- preventDefault（）方法，取消事件的默认行为，cancelable 为 true 时可以调用
- stopImmediatePropagation（）方法，取消事件的进一步捕获或冒泡，同时阻止任何事件处理程序被调用（DOM3新增）
- stopPropagation（）方法，取消事件的进一步捕获或冒泡，bubbles 为 true 时可以调用。



​		**一些特性：**

- 事件处理程序内部，this 始终等于 currentTarget 的值；target 只包含事件的目标元素。
- 只有在事件处理程序执行期间，event才存在，一旦该函数执行完毕，event 对象就会被销毁。

### IE 中的事件对象

